# nanochat 完整文件清单

## 所有源代码文件列表

### 核心库文件 (nanochat/)

```
nanochat/
├── __init__.py              (0B)   # 包初始化文件
│
├── GPT模型相关
│   └── gpt.py              (14KB)  # GPT Transformer模型实现
│       - GPTConfig配置类
│       - RoPE旋转编码实现
│       - Attention层 (支持GQA)
│       - MLP层 (ReLU^2激活)
│       - 完整GPT模型类
│
├── 分词器相关  
│   └── tokenizer.py        (17KB)  # BPE分词器实现
│       - HuggingFaceTokenizer包装
│       - RustBPE Python绑定
│       - Tiktoken集成
│       - 特殊tokens管理
│
├── 推理相关
│   └── engine.py           (17KB)  # 高效推理引擎
│       - Engine推理类
│       - Token生成管道
│       - KV缓存管理
│       - 计算器工具集成
│
├── 优化器相关
│   ├── adamw.py            (3.3KB) # AdamW优化器
│   │   - 分布式AdamW实现
│   │   - 梯度累积支持
│   │
│   └── muon.py             (9.4KB) # Muon优化器
│       - Muon优化器实现
│       - 分布式Muon支持
│
├── 数据处理相关
│   ├── dataset.py          (5.3KB) # 数据集处理
│   │   - HuggingFace数据加载
│   │   - 预处理管道
│   │
│   ├── dataloader.py       (5.1KB) # 数据加载器
│   │   - 批次加载
│   │   - 分布式采样
│   │
│   └── checkpoint_manager.py (6.4KB) # 检查点管理
│       - 模型保存
│       - 模型恢复
│       - 优化器状态管理
│
├── 评估相关
│   ├── core_eval.py        (11KB)  # 核心评估
│   │   - CORE基准评估
│   │   - 困惑度计算
│   │
│   ├── loss_eval.py        (3.1KB) # 损失评估
│   │   - 各种损失计算
│   │
│   └── report.py           (15KB)  # 报告生成
│       - Markdown报告生成
│       - 指标汇总
│       - 性能对比表格
│
├── 工具和配置
│   ├── common.py           (7.6KB) # 通用工具
│   │   - 分布式训练工具
│   │   - 设备检测
│   │   - 日志函数
│   │   - 初始化函数
│   │
│   ├── execution.py        (10KB)  # 执行管理
│   │   - 训练循环管理
│   │   - 回调系统
│   │
│   └── configurator.py     (2.0KB) # 配置管理
│       - 参数配置
│       - 命令行参数解析
│
└── UI资源
    ├── ui.html             # 聊天Web界面HTML
    └── logo.svg            # 项目logo
```

### 训练脚本 (scripts/)

```
scripts/
│
├── 预训练阶段 (Base)
│   ├── base_train.py       (19KB)  # 基础预训练主脚本
│   │   - Causal language modeling
│   │   - 多GPU分布式支持
│   │   - 检查点和恢复
│   │   - 评估回调
│   │
│   ├── base_eval.py        (8.2KB) # 预训练评估
│   │   - 困惑度评估
│   │   - CORE基准评估
│   │
│   └── base_loss.py        (3.1KB) # 损失计算
│       - 因果语言模型损失
│
├── 继续训练阶段 (Mid)
│   └── mid_train.py        (14KB)  # 中间训练脚本
│       - 在预训练基础继续
│       - 混合数据集训练
│       - 多基准评估
│
├── 微调阶段 (Chat)
│   ├── chat_sft.py         (12KB)  # 监督微调
│   │   - 对话格式训练
│   │   - 指令跟随
│   │   - 特殊tokens处理
│   │
│   ├── chat_rl.py          (15KB)  # 强化学习微调
│   │   - 奖励模型集成
│   │   - PPO算法
│   │   - 策略优化
│   │
│   └── chat_eval.py        (12KB)  # 聊天评估
│       - 对话质量评估
│       - 多基准评分
│
├── 分词器阶段 (Tokenizer)
│   ├── tok_train.py        (4.2KB) # 分词器训练
│   │   - BPE训练
│   │   - 词表构建
│   │
│   └── tok_eval.py         (12KB)  # 分词器评估
│       - 压缩率测试
│       - 性能基准
│
└── 推理服务
    ├── chat_web.py         (16KB)  # Web服务器
    │   - FastAPI应用
    │   - WebSocket支持
    │   - HTML前端集成
    │   - 聊天端点
    │
    └── chat_cli.py         (4.2KB) # CLI聊天
        - 命令行交互
        - 流式输出
```

### 评估任务 (tasks/)

```
tasks/
│
├── common.py               (5.4KB) # 任务基类和公共代码
│   - BaseTask基类
│   - 结果处理
│   - 指标计算
│
├── arc.py                  (2.1KB) # ARC Challenge
│   - 常识推理任务
│   - 4个选项, 1标准答案
│   - 简单和困难版本
│
├── gsm8k.py                (4.8KB) # GSM8K 数学推理
│   - 数学应用题
│   - 需要推理步骤
│
├── humaneval.py            (3.3KB) # HumanEval 代码生成
│   - 164个编程题
│   - 功能正确性测试
│
├── mmlu.py                 (3.8KB) # MMLU 多学科考试
│   - 57个主题
│   - 多选题 (A/B/C/D)
│
├── spellingbee.py          (12KB)  # Spelling Bee 单词游戏
│   - 单词组合
│   - 字母使用规则
│
├── smoltalk.py             (2.0KB) # SmolTalk 对话
│   - 对话评估
│   - 自然语言交互
│
└── customjson.py           (2.9KB) # 自定义JSON任务
    - 通用JSON格式支持
    - 灵活的任务定义
```

### 测试文件 (tests/)

```
tests/
├── test_engine.py          # 推理引擎测试
│   - 模型加载测试
│   - Token生成测试
│   - 批处理测试
│
└── test_rustbpe.py         # Rust BPE分词器测试
    - 分词正确性
    - 性能基准
```

### Rust分词器 (rustbpe/)

```
rustbpe/
├── Cargo.toml              # Rust项目配置
│   name: rustbpe
│   version: 0.1.0
│   dependencies:
│   - dary_heap
│   - indexmap
│   - fancy-regex
│   - rayon (并行处理)
│   - pyo3 (Python绑定)
│   - ahash (高速哈希)
│   - compact_str (优化字符串)
│
├── README.md               # Rust模块说明
│
└── src/
    └── lib.rs              # BPE分词器Rust实现
        - 编码器
        - 解码器
        - BPE算法
        - 并行处理
```

### 配置文件

```
根目录/
├── pyproject.toml          # Python项目配置
│   - 项目元数据
│   - 依赖声明
│   - uv配置
│   - pytest配置
│   - torch CPU/GPU选择配置
│
├── uv.lock                 # 依赖锁定文件
│   - 完整依赖树 (2004行)
│   - 版本固定
│
├── .python-version         # Python版本指定 (3.10)
│
├── .gitignore              # Git忽略配置
│   .venv/
│   __pycache__/
│   rustbpe/target/
│   report.md
│   eval_bundle/
│
└── LICENSE                 # 项目许可证
```

### Shell脚本

```
根目录/
├── speedrun.sh             (6.2KB) # 4小时完整训练流程
│   - 数据准备
│   - 预训练
│   - 微调
│   - 评估
│   - 推理服务启动
│
└── run1000.sh              (4.9KB) # 1000个GPU小时训练
    - 大规模训练脚本
    - 更多数据和更多epochs

dev/
├── runcpu.sh               # CPU/MPS运行脚本
│   - 小规模模型配置
│   - 减少批大小
│   - 减少训练步数
│
├── gen_synthetic_data.py    # 生成合成训练数据
├── repackage_data_reference.py # 数据重新打包工具
├── generate_logo.html       # Logo生成
└── nanochat.png            # 项目图标
```

### 文档文件

```
根目录/
├── README.md               # 项目主文档
│   - 快速开始
│   - 安装说明
│   - 使用示例
│   - 性能对比
│
├── report.md               # 训练结果报告 (自动生成, 已忽略)
│   - 性能指标
│   - 评估结果汇总
│   - 训练耗时
│
└── rustbpe/README.md       # Rust模块文档
    - Rust代码说明
```

## 文件大小统计

### 按模块统计
```
nanochat/
├── 模型相关          gpt.py (14KB) + tokenizer.py (17KB) = 31KB
├── 推理相关          engine.py (17KB) = 17KB  
├── 优化器           adamw.py (3.3KB) + muon.py (9.4KB) = 12.7KB
├── 数据处理         dataset.py + dataloader.py + checkpoint_manager.py = 16.8KB
├── 评估             core_eval.py + loss_eval.py + report.py = 29KB
├── 工具配置         common.py + execution.py + configurator.py = 19.6KB
└── 总计: ~126KB (14个文件)

scripts/
├── 训练脚本         base_train.py + mid_train.py + chat_sft.py + chat_rl.py = 56KB
├── 评估脚本         base_eval.py + chat_eval.py + tok_eval.py = 32.2KB
├── 其他脚本         其余脚本 = 25.8KB
└── 总计: ~114KB (11个文件)

tasks/
├── 总计: ~36KB (8个文件)

tests/
├── 总计: ~(2个文件)
```

### 代码行数估算
```
nanochat/    ~1500 行
scripts/     ~1800 行
tasks/       ~800 行
tests/       ~200 行
rustbpe/     ~600 行
───────────────────
总计:        ~6700 行
```

## 关键文件依赖关系

```
数据流:
dataset.py → dataloader.py → 训练脚本
                               ↓
                            gpt.py (model)
                               ↓
                        engine.py (inference)
                               ↓
                     chat_web.py / chat_cli.py

训练流:
base_train.py (stage 1)
    ↓
mid_train.py (stage 2)
    ↓
chat_sft.py (stage 3a)
    ↓
chat_rl.py (stage 3b)

评估流:
core_eval.py + tasks/* → report.py (生成报告)

推理流:
engine.py ← gpt.py + tokenizer.py
    ↓
chat_web.py (FastAPI Web)
chat_cli.py (CLI)

分词流:
rustbpe/ (Rust编译成Python模块)
tokenizer.py (Python包装)
```

## 特殊文件说明

### ui.html
- FastAPI服务提供的前端
- 包含聊天界面
- WebSocket连接处理

### logo.svg
- 项目品牌logo
- 在README中使用

### report.md (自动生成)
- speedrun.sh完成后生成
- 包含所有评估结果
- 汇总性能指标表

## 文件总数统计

| 类型 | 数量 |
|------|------|
| Python源文件 (.py) | 36 |
| Rust源文件 (.rs) | 1 |
| 配置文件 (.toml) | 2 |
| Shell脚本 (.sh) | 3 |
| 文档 (.md) | 3 |
| HTML文件 | 2 |
| SVG图标 | 1 |
| 锁定文件 (.lock) | 1 |
| **总计** | **49** |

